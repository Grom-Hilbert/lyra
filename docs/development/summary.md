# Lyra - 企业级云原生文档管理系统项目说明书

---

## 1. 项目概述

### 1.1. 项目背景与目标

* **项目背景**：我需要在公司内网搭建一个以K8s为基础的私有云集群，并完成云原生业务系统的设计与实现。当前项目为该云原生系统的一个组件，用于为企业内部提供带有版本控制的文档管理系统。
* **核心目标**：实现一个云原生的带有版本控制的企业级网盘，支持WebDAV协议并内置Git版本控制，能够以插件形式扩展更多丰富的功能，满足中小型企业（10-100人）多样化的文档管理需求。
* **开发策略**：采用个人快速开发模式，分阶段实现核心功能和扩展功能，确保每个阶段都能为企业用户提供实用价值。

---

## 2. 功能规格说明

### 2.1. 核心功能模块（第一阶段 - MVP）

#### 2.1.1. 身份认证模块

* **功能点1**：支持用户的注册与基础登录（注册使用邮箱，且需超级管理员审批）
* **功能点2**：支持多种认证方式：本地认证、OAuth2、OIDC、LDAP等
* **功能点3**：支持JWT令牌认证，提供令牌刷新机制
* **功能点4**：提供用户、角色、权限的可视化管理界面

#### 2.1.2. 权限管理模块

* **功能点1**：实现RBAC（基于角色的访问控制），设置超级管理员、管理员、用户、访客4种角色
* **功能点2**：支持细粒度权限控制，包括文件/文件夹的读、写、删除、分享权限
* **功能点3**：支持权限继承机制，子文件夹继承父文件夹权限
* **功能点4**：支持临时权限授权，可设置权限有效期

#### 2.1.3. 文件管理模块

* **功能点1**：支持文件的上传、下载、删除、移动、复制、重命名、分享（可限制权限）等操作
* **功能点2**：支持受支持格式文件（主要为文本、图片）的预览与压缩文件的解压
* **功能点3**：支持文件夹的创建、删除、复制、移动、重命名、分享（可限制权限）等操作
* **功能点4**：划分企业空间和个人空间；其中企业空间默认共享给所有用户，由超级管理员控制；企业空间下存在若干根目录，由管理员控制；用户可控制其在根目录下创建的文件夹及个人空间；访客无企业空间和个人空间，仅能看到用户分享的文件或文件夹
* **功能点5**：支持对纯文本文件的即时编辑
* **功能点6**：记录文件元数据，支持通过文件名进行字符串匹配搜索
* **功能点7**：支持WebDAV协议，用户可分别将企业空间和个人空间挂载至本地

#### 2.1.4. 基础版本控制模块

* **功能点1**：支持三种版本控制模式——无版本控制、普通版本控制和高级版本控制，用户在创建文件夹时可选择
* **功能点2**：普通版本控制与WebDAV兼容，支持二进制文件的版本控制
* **功能点3**：高级版本控制基于Git实现，在二进制文件版本控制的基础上增加对文本文件内容的版本控制
* **功能点4**：用于版本控制的辅助文件/文件夹（如.git/.gitignore等）对用户不可见

#### 2.1.5. 数据管理模块

* **功能点1**：使用SQL数据库对用户数据、文件元数据等进行持久化存储
* **功能点2**：默认使用内置的SQLite数据库，支持在初始化阶段切换到外部数据库（MySQL、PostgreSQL）
* **功能点3**：支持通过Redis接口实现文件热数据的缓存加速，如果未配置Redis地址则使用内存进行缓存

#### 2.1.6. 用户设置模块

* **功能点1**：支持用户在设置中自定义界面外观及各项可变功能
* **功能点2**：支持用户在设置中自定义插件配置

### 2.2. 扩展功能模块（第二阶段）

#### 2.2.1. 高级版本控制模块

* **功能点1**：当启用高级版本控制的文件夹通过WebDAV协议打开时，所有文本文件锁定为只读模式，只对二进制文件进行WebDAV兼容的版本控制
* **功能点2**：Git支持连接到远程Git仓库进行自动推送
* **功能点3**：当用户在启用版本控制的文件夹中执行文件创建或上传操作时，始终询问当前操作是否在进行版本更新，如果是更新操作，则提供被覆盖文件的选项
* **功能点4**：当用户在启用高级版本控制的文件夹中执行文件创建或上传操作时，如果该文件是非文本文件且支持转换为文本文件，则先询问用户是否需要进行格式转换
* **功能点5**：当用户在启用版本控制的文件夹中批量上传文件时，应以列表形式依次询问所有文件，并支持全选操作

#### 2.2.2. 模板仓库模块

* **功能点1**：支持以模板方式创建文件夹，模板中能够定义该文件夹拥有哪些文件，这些文件的默认内容，以及所有文件和文件夹的读写权限
* **功能点2**：支持以模板仓库的方式对所有模板进行管理，支持模板分享

#### 2.2.3. 插件扩展模块

* **功能点1**：实现插件化框架，为应用前端、后端均提供插件扩展能力
* **功能点2**：支持插件的安装、卸载、启用、禁用、升级等操作

### 2.3. 插件功能规格（第三阶段）

#### 2.3.1. 基础插件（优先开发）

**文件预览扩展插件：**

* **功能点1**：支持更多格式文件的预览

**文本编辑扩展插件：**

* **功能点1**：支持对各类代码、配置格式、技术文档等常见文本格式的格式化与语法高亮
* **功能点2**：支持md格式的富文本编辑（带预览）

**Git扩展插件：**

* **功能点1**：支持在文件夹页面中点击按钮查看Git提交历史，以及进行版本回溯
* **功能点2**：支持在文件预览页面中查看每一行文本的最后编辑者与编辑时间，以及点击按钮查看版本差异

#### 2.3.2. 高级插件（后续开发）

**MeiliSearch插件：**

* **功能点1**：通过连接外部的MeiliSearch服务实现全文检索、语义检索（向量检索）功能，替换网盘原有的简单搜索引擎
* **功能点2**：监听网盘文件变更事件，自动触发Tika内容提取，将文件元数据与文件内容发送至MeiliSearch建立索引
* **功能点3**：在用户界面提供选项，让用户自行选择文件名匹配、全文检索和语义检索

**AI助手插件：**

* **功能点1**：支持在网盘界面侧边栏打开对话窗口与AI进行即时对话，可自定义大模型选项
* **功能点2**：支持网盘文件与AI对话的联动，使用@将当前文件夹中的文件引用到对话窗口中，提交文件内容给大模型进行交互
* **功能点3**：支持AI总结Git提交历史与版本差异
* **功能点4**：支持AI总结文件检索结果

**OnlyOffice插件：**

* **功能点1**：支持从网盘页面以OnlyOffice形式打开office文件进行编辑
* **功能点2**：自动进入实时协同编辑模式
* **功能点3**：在实时协同编辑与二进制文件版本控制之间建立兼容机制

**历史模板插件：**

* **功能点1**：只有当应用连接到远程Git仓库时可启用，提供一类特殊的文件夹模板，通过克隆远程仓库进行文件夹创建，且默认启用高级版本控制

### 2.4. RESTful接口

系统采用RESTful架构风格设计API接口，除了实现前后端功能性交互接口外，还需要额外实现一系列用于系统运维、监控和管理的接口。

#### 2.4.1. 核心业务接口

包含身份认证、用户管理、文件管理、文件夹管理、版本控制、模板管理、插件管理、权限管理等功能模块的完整RESTful接口，遵循标准HTTP方法语义和状态码规范。

#### 2.4.2. 系统管理与运维接口

必要的系统管理与运维接口，如健康检查、系统监控、系统调试等。

---

## 3. 技术架构

### 3.1. 技术选型

| 领域         | 技术/框架                     | 版本            | 备注                                  |
|------------|---------------------------|---------------|-------------------------------------|
| **语言**     | Java, TypeScript          | 21+, 5.x+     | 后端使用Java，前端使用TypeScript             |
| **前端框架**   | Vue                       | 3.5+          | 配合Vue Router、Pinia状态管理              |
| **后端框架**   | SpringBoot                | 3.5.x         | 集成Spring Security、Spring Data JPA   |
| **数据库**    | SQLite, MySQL, PostgreSQL | 3+, 8.x+, 15+ | SQLite作为默认数据库，支持切换到MySQL/PostgreSQL |
| **缓存**     | Redis                     | 8.x+          | 用于缓存热点数据，支持集群模式                     |
| **文档生成**   | Swagger/OpenAPI           | 3.x           | 自动生成API文档                           |
| **版本控制**   | JGit                      | 6.x+          | Java Git实现，用于高级版本控制                 |
| **文件处理**   | Apache Tika               | 2.x+          | 文件内容提取和格式转换                         |
| **WebDAV** | Milton WebDAV             | 3.x+          | WebDAV协议实现                          |
| **容器化**    | Docker, Kubernetes        | 20.x+, 1.26+  | 支持容器化部署                             |
| **构建工具**   | Gradle                    | 8.x+          | 项目构建和依赖管理                           |
| **CI/CD**  | Github Actions, ArgoCD    |               | Github Actions负责构建，ArgoCD负责部署       |
| **可观测性**   | OpenTelemetry, Alloy      |               | 统一可观测性数据收集                          |

### 3.2. 系统架构

系统采用分层架构设计：

```plaintext
┌─────────────────────────────────────────────────────────────┐
│                    前端界面层 (Vue + TypeScript)             │
├─────────────────────────────────────────────────────────────┤
│                   应用服务层 (Spring Boot)                   │
├─────────────────────────────────────────────────────────────┤
│                   数据访问层 (Spring Data JPA)               │
├─────────────────────────────────────────────────────────────┤
│               数据存储层 (SQLite/MySQL + Redis + 文件存储)     │
└─────────────────────────────────────────────────────────────┘
```

**核心组件：**

* **前端**：Vue 3.5+ + TypeScript + Vite
* **后端**：Spring Boot 3.5.x + Spring Security + JPA
* **数据库**：SQLite (默认) / MySQL / PostgreSQL
* **缓存**：Redis (可选)
* **文件存储**：本地文件系统 / NFS / S3兼容存储
* **插件系统**：动态加载机制

### 3.3. 外部软件集成

系统支持多种外部服务集成，提供灵活的扩展能力和企业级功能，其中部分属于插件功能，仅在实现插件时需要集成。

#### 3.3.1. 存储服务

* **集成目的**：替代本地磁盘存储，支持分布式文件存储
* **支持协议**：NFS、SMB/CIFS、WebDAV、S3 Compatible API
* **配置方式**：通过配置文件或环境变量指定存储后端
* **故障转移**：支持多存储后端配置，实现高可用性

#### 3.3.2. 数据库服务

* **集成目的**：替代内置SQLite，提供企业级数据库支持
* **支持数据库**：MySQL 8.0+、PostgreSQL 15+
* **连接方式**：JDBC连接池，支持读写分离
* **迁移工具**：提供数据库迁移脚本和工具

#### 3.3.3. 缓存服务

* **集成目的**：提升系统性能，缓存热点数据
* **支持协议**：Redis Protocol Compatible
* **缓存策略**：支持LRU、LFU等多种缓存策略
* **集群支持**：支持Redis Cluster和Sentinel模式

#### 3.3.4. 搜索引擎

* **集成目的**：提供全文检索、语义检索等高级搜索功能
* **支持引擎**：MeiliSearch、Elasticsearch（插件扩展）
* **索引策略**：实时索引更新，支持增量索引
* **搜索功能**：文件名搜索、内容搜索、语义搜索

#### 3.3.5. 配置中心

* **集成目的**：实现配置的集中管理和动态更新
* **支持服务**：Nacos、Consul（插件扩展）
* **配置同步**：支持配置热更新，无需重启服务
* **配置版本**：支持配置版本管理和回滚

#### 3.3.6. 可观测性

* **集成目的**：统一收集和导出系统的监控数据
* **数据收集**：Grafana Alloy（原Grafana Agent）
* **数据类型**：指标（Metrics）、日志（Logs）、链路追踪（Traces）
* **导出目标**：Prometheus、Loki、Jaeger等

#### 3.3.7. AI服务

* **集成目的**：为系统提供AI能力，提升用户体验
* **支持协议**：OpenAI Compatible API
* **支持模型**：GPT系列、Claude、本地部署模型等
* **功能应用**：智能问答、内容总结、代码分析等

---

## 4. 开发策略与规范

### 4.1. 分阶段开发策略

#### 4.1.1. 第一阶段：MVP核心功能

**开发优先级：**

1. 用户认证与权限管理
2. 基础文件管理功能
3. WebDAV协议支持
4. 简单版本控制
5. 基础用户界面

**验收标准：**

* 支持10-50人的企业团队使用
* 文件上传下载、WebDAV挂载正常工作
* 基础权限控制和用户管理
* 简单的版本控制功能

#### 4.1.2. 第二阶段：高级功能

**开发优先级：**

1. 高级Git版本控制
2. 模板仓库功能
3. 插件框架搭建
4. 文件预览和编辑
5. 基础插件开发

**验收标准：**

* 完整的Git版本控制功能
* 支持文件夹模板创建
* 插件系统可用
* 基础的文件预览和编辑

#### 4.1.3. 第三阶段：插件扩展

**开发优先级：**

1. Git扩展插件
2. 历史模板插件
3. 文本编辑扩展插件
4. 搜索增强插件
5. 协同办公插件
6. AI助手插件

### 4.2. 代码规范

#### 4.2.1. Java代码规范

* 遵循Google Java Style Guide或阿里巴巴Java开发手册
* 使用Lombok减少样板代码，但避免过度使用
* 统一使用UTF-8编码，行尾使用LF
* 类名使用PascalCase，方法名和变量名使用camelCase
* 常量使用UPPER_SNAKE_CASE

#### 4.2.2. TypeScript/Vue代码规范

* 遵循Vue官方风格指南和TypeScript最佳实践
* 使用ESLint和Prettier进行代码格式化
* 组件名使用PascalCase，文件名使用kebab-case
* 使用TypeScript严格模式，避免使用any类型

#### 4.2.3. 数据库规范

* 表名和字段名使用snake_case命名
* 主键统一使用id，外键使用{table}_id格式
* 必须字段设置NOT NULL约束
* 为查询字段添加适当索引

#### 4.2.4. Git提交规范

* 使用Conventional Commits规范
* 提交信息格式：`type(scope): description`
* 类型包括：feat、fix、docs、style、refactor、test、chore
* 每次提交应该是一个完整的功能点或修复

### 4.3. 开发环境要求

* 本项目在Win11环境下开发，但需在Linux（CentOS）环境下部署使用
* 开发时需调用标准库、第三方库、SDK、API时，应使用尽可能新的版本
* 统一使用Docker进行本地开发环境搭建

**开发工具要求：**

* **Java开发**：IntelliJ IDEA 2024.1+
* **前端开发**：VS Code / WebStorm  
* **数据库管理**：DBeaver / DataGrip
* **API测试**：Postman / Insomnia
* **版本控制**：Git 2.40+

---

## 5. 部署与运维

### 5.1. CI/CD流程

#### 5.1.1. 持续集成

1. 代码提交触发构建
2. 静态代码检查 (ESLint, SonarQube)  
3. 单元测试执行
4. 应用构建打包
5. Docker镜像制作

**使用Github Actions进行项目构建与测试，需编写`.github/workflows`相关文件。**

#### 5.1.2. 持续部署

1. 从镜像仓库拉取最新镜像
2. 更新Kubernetes配置文件
3. 滚动部署到目标环境
4. 健康检查验证

**使用ArgoCD进行项目部署，需编写`argocd.yaml`文件。**

### 5.2. 配置管理

1. **静态配置**：使用静态配置文件（yaml）作为所有配置项的最初输入源，并在`default.yml`中设置所有配置的默认值，优先级最低
2. **环境变量**：通过环境变量获取部分与环境相关的配置（如数据库或外部服务的地址、密码等），优先级高于静态配置
3. **命令行参数**：通过解析命令行参数获取少数需要在程序启动时临时修改的配置（如切换开发模式与生产模式），优先级高于环境变量，但仅用于开发调试
4. **动态配置**：通过外部配置中心（Nacos）获取需要在软件运行中动态变更的配置，优先级最高

### 5.3. 部署方式

* **Docker**：支持通过docker与docker-compose进行部署
* **Kubernetes**：支持通过k8s进行部署，注意使用ConfigMap和Secrets注入环境变量
* **Helm**：支持通过helm进行部署

### 5.4. 可观测性

* **OpenTelemetry**: 使用OpenTelemetry SDK统一导出指标、日志与追踪数据
* **Alloy**: 连接到外部Alloy收集器，将OpenTelemetry数据发送到目标上

---

## 6. 配置示例

### 6.1. application.yml示例

```yaml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  application:
    name: lyra
  datasource:
    url: jdbc:sqlite:data/lyra.db
    driver-class-name: org.sqlite.JDBC
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false

lyra:
  storage:
    type: local
    path: /data/files
  auth:
    jwt:
      secret: ${JWT_SECRET:default-secret}
      expiration: 86400
  webdav:
    enabled: true
    path: /webdav
  version-control:
    enabled: true
    default-mode: simple
  plugins:
    enabled: true
    auto-load: true
  enterprise:
    max-users: 100
    storage-quota: 1TB
```

### 6.2. Docker Compose示例

```yaml
version: '3.8'
services:
  lyra-app:
    image: lyra:latest
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - DATABASE_URL=jdbc:postgresql://db:5432/lyra
      - REDIS_URL=redis://redis:6379
    volumes:
      - lyra_data:/app/data
    depends_on:
      - db
      - redis

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=lyra
      - POSTGRES_USER=lyra
      - POSTGRES_PASSWORD=lyra_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

volumes:
  lyra_data:
  postgres_data:
  redis_data:
```

### 6.3. 快速启动

```bash
# 1. 克隆代码
git clone https://github.com/your-org/lyra.git
cd lyra

# 2. 启动后端
./gradlew bootRun

# 3. 启动前端
cd frontend
npm install
npm run dev

# 4. 使用Docker Compose
docker-compose up -d
```

---

**文档版本**: v1.0  
**最后更新**: 2025年7月
